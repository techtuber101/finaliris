# Environment Configuration Guide

This project supports seamless switching between local development and production environments while maintaining consistent UI/UX across both modes.

## Quick Start

Use the provided script to switch between environments:

```bash
# Switch to local development mode
./switch-env.sh local

# Switch to production mode  
./switch-env.sh production
```

## Environment Modes

### Local Development Mode (`local`)
- **Frontend**: `http://localhost:3000`
- **Backend API**: `http://localhost:8000/api`
- **Caddy**: Disabled (direct access to services)
- **UI**: Consistent with production (no environment-specific changes)

### Production Mode (`production`)
- **Frontend**: `https://irisvision.ai`
- **Backend API**: `https://irisvision.ai/api`
- **Caddy**: Enabled (reverse proxy with SSL)
- **UI**: Consistent with local (no environment-specific changes)

## Configuration Files

### Frontend Environment Files
- `frontend/.env.local.example` - Template for local development
- `frontend/.env.production.example` - Template for production
- `frontend/.env.local` - Active configuration (generated by switch script)

### Docker Compose Files
- `docker-compose.yaml` - Base configuration
- `docker-compose.local.yml` - Local development overrides
- `docker-compose.production.yml` - Production overrides

## Manual Configuration

If you prefer to configure manually:

### 1. Frontend Configuration

Create `frontend/.env.local` with appropriate values:

**For Local Development:**
```env
NEXT_PUBLIC_ENV_MODE=local
NEXT_PUBLIC_URL=http://localhost:3000
NEXT_PUBLIC_BACKEND_URL=http://localhost:8000/api
# ... other variables
```

**For Production:**
```env
NEXT_PUBLIC_ENV_MODE=production
NEXT_PUBLIC_URL=https://irisvision.ai
NEXT_PUBLIC_BACKEND_URL=https://irisvision.ai/api
# ... other variables
```

### 2. Backend Configuration

Update `backend/.env`:

**For Local Development:**
```env
ENV_MODE=local
WEBHOOK_BASE_URL=http://localhost:8000
FRONTEND_URL=http://localhost:3000
```

**For Production:**
```env
ENV_MODE=production
WEBHOOK_BASE_URL=https://irisvision.ai
FRONTEND_URL=https://irisvision.ai
```

### 3. Docker Compose

**For Local Development:**
```bash
docker-compose -f docker-compose.yaml -f docker-compose.local.yml up
```

**For Production:**
```bash
docker-compose -f docker-compose.yaml -f docker-compose.production.yml up
```

## Running the Application

### Local Development

**Option 1: Using Docker Compose**
```bash
./switch-env.sh local
docker-compose -f docker-compose.yaml -f docker-compose.local.yml up
```

**Option 2: Mixed Development**
```bash
# Terminal 1: Backend
cd backend
docker-compose up

# Terminal 2: Frontend
cd frontend
npm run dev:3000
```

### Production Deployment

```bash
./switch-env.sh production
docker-compose -f docker-compose.yaml -f docker-compose.production.yml up
```

## UI Consistency

The application is configured to maintain identical UI/UX across both local and production modes. This means:

- ✅ No "local development mode" banners
- ✅ No disabled billing features in local mode
- ✅ Consistent feature availability
- ✅ Same look and feel

### Disabling UI Changes

The configuration includes `DISABLE_ENV_UI_CHANGES: true` in `frontend/src/lib/config.ts`. This ensures that:

- Billing modals work the same way in both modes
- Pricing sections are always available
- No environment-specific UI elements are shown

## Key Features

### Environment Detection
The application automatically detects the current environment mode using:
- `NEXT_PUBLIC_ENV_MODE` environment variable
- Fallback to `NODE_ENV` if not set

### Caddy Configuration
- **Local Mode**: Caddy is disabled, services run on localhost ports
- **Production Mode**: Caddy handles SSL termination and reverse proxying

### API Routing
- **Local Mode**: Direct API calls to `localhost:8000/api`
- **Production Mode**: API calls routed through Caddy to `irisvision.ai/api`

## Troubleshooting

### Common Issues

1. **Port Conflicts**: Ensure ports 3000 and 8000 are available
2. **Environment Variables**: Check that `.env.local` files are properly configured
3. **Docker Services**: Use `docker-compose ps` to check service status

### Debugging

1. **Check Environment Mode**:
   ```bash
   # In browser console
   console.log(process.env.NEXT_PUBLIC_ENV_MODE)
   ```

2. **Verify API Endpoints**:
   ```bash
   # Local
   curl http://localhost:8000/api/health
   
   # Production
   curl https://irisvision.ai/api/health
   ```

3. **Docker Logs**:
   ```bash
   docker-compose logs frontend
   docker-compose logs backend
   ```

## Development Workflow

1. **Start Local Development**:
   ```bash
   ./switch-env.sh local
   docker-compose -f docker-compose.yaml -f docker-compose.local.yml up
   ```

2. **Make Changes**: Edit code as needed

3. **Test Production Build**:
   ```bash
   ./switch-env.sh production
   docker-compose -f docker-compose.yaml -f docker-compose.production.yml up
   ```

4. **Deploy**: Use production configuration for deployment

## Security Notes

- Environment variables are loaded from `.env.local` files
- Never commit `.env.local` files to version control
- Use `.env.example` files as templates
- Production deployments should use secure environment variable injection
